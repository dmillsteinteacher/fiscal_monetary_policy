<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Analysis: MLF & AS-AD Simulator V29 (Final Fix)</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        /* CSS for a clean, educational layout */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f4f8;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        h1 {
            color: #004d99;
            text-align: center;
            border-bottom: 3px solid #004d99;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        h2 {
            color: #28a745;
            margin-top: 30px;
        }
        h3 {
            color: #0056b3;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .graph-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 40px;
        }
        .graph {
            width: 50%;
            height: 450px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #fff;
        }
        .policy-controls {
            padding: 20px;
            border: 1px solid #ff9900;
            border-radius: 8px;
            background-color: #fffaf0;
        }
        .slider-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #d9534f;
        }
        input[type=range] {
            width: 100%;
        }
        .policy-value {
            font-weight: bold;
            color: #007bff;
        }
        .policy-output {
            margin-top: 15px;
            padding: 10px;
            border: 1px dashed #004d99;
            border-radius: 4px;
        }
        .output-value {
            font-weight: bold;
            color: #007bff;
        }
        .lras-impact {
            font-weight: bold;
        }
        .lras-negative { color: red; }
        .lras-positive { color: green; }
        .lras-neutral { color: orange; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Policy Analysis: Loanable Funds (MLF) and AS-AD Graphs (V29)</h1>

        <div class="policy-controls">
            <h2>Policy Simulation Controls ðŸ§ª</h2>

            <div class="slider-group">
                <label for="fiscalPolicy">Fiscal Policy (Government Deficit/Surplus): <span id="fiscalValue" class="policy-value">0</span></label>
                <input type="range" id="fiscalPolicy" min="-15" max="15" value="0" step="1" oninput="updateGraphs()">
                <small>Negative = Contractionary (DLF shifts Left); Positive = Expansionary (DLF shifts Right)</small>
            </div>

            <div class="slider-group">
                <label for="monetaryPolicy">Monetary Policy (Money Supply Change): <span id="monetaryValue" class="policy-value">0</span></label>
                <input type="range" id="monetaryPolicy" min="-15" max="15" value="0" step="1" oninput="updateGraphs()">
                <small>Negative = Contractionary (SLF shifts Left); Positive = Expansionary (SLF shifts Right)</small>
            </div>

            <div class="policy-output">
                <h3>Calculated Equilibrium Outcomes</h3>
                <p>New Real Interest Rate ($r$): <span id="r_new_output" class="output-value">5.00%</span></p>
                <p>New Price Level ($\text{PL}$): <span id="pl_new_output" class="output-value">100.00</span></p>
                <p>New Real GDP ($\text{RGDP}$): <span id="rgdp_new_output" class="output-value">500.00</span></p>
                <p>Long-Run Growth Impact ($\text{LRAS}$): <span id="lras_impact_output" class="lras-impact lras-neutral">Neutral</span></p>
            </div>
        </div>

        <div class="graph-container">
            <div id="mlfGraph" class="graph"></div>
            <div id="asadGraph" class="graph"></div>
        </div>
        
    </div>

    <script>
        // --- Core Graphing Logic (JavaScript) ---

        // Constants for initial equilibrium and graph range
        const EQ_R = 5;      // Initial Real Interest Rate (r)
        const EQ_Q = 100;    // Initial Quantity of Loanable Funds (QLF)
        const EQ_PL = 100;   // Initial Price Level (PL)
        const EQ_RGDP = 500; // Initial Real GDP (rgdp)
        const SLOPE_D = 0.5; // Slope for Demand (DLF/AD)
        const SLOPE_S = 0.5; // Slope for Supply (SLF/AS)
        const MAX_RGDP = 550; // For Long-Run Aggregate Supply (LRAS)
        
        // ECONOMIC CONSTANTS (ADJUSTED FOR FIX)
        const AD_SENSITIVITY = 2.0; // Reduced sensitivity to ensure crowding out is smaller than fiscal effect
        const FISCAL_MULTIPLIER = 3.0; // Increased multiplier to ensure fiscal effect dominates
        
        // --- 1. Loanable Funds Market (MLF) Functions ---
        
        function getMLFCurve(r, shift, isDemand) {
            let q = [];
            for (let i = 0; i < r.length; i++) {
                if (isDemand) {
                    q.push(EQ_Q + (EQ_R - r[i]) / SLOPE_D + shift);
                } else {
                    q.push(EQ_Q + (r[i] - EQ_R) / SLOPE_S + shift);
                }
            }
            return q;
        }

        function calculateMLFEquilibrium(fiscalShift, monetaryShift) {
            const sum_slopes = SLOPE_D + SLOPE_S;
            const r_new = EQ_R + (SLOPE_D * SLOPE_S / sum_slopes) * (fiscalShift - monetaryShift);
            const q_new = EQ_Q + (SLOPE_S * fiscalShift + SLOPE_D * monetaryShift) / sum_slopes;
            return { r_new, q_new };
        }

        function createMLFGraph(fiscalShift, monetaryShift) {
            const r_range = Array.from({ length: 41 }, (_, i) => 1 + i * 0.2); 
            const { r_new, q_new } = calculateMLFEquilibrium(fiscalShift, monetaryShift);
            
            const dlf_base = getMLFCurve(r_range, 0, true);
            const slf_base = getMLFCurve(r_range, 0, false);
            const dlf_new = getMLFCurve(r_range, fiscalShift, true);
            const slf_new = getMLFCurve(r_range, monetaryShift, false); 

            const traces = [
                { x: dlf_base, y: r_range, mode: 'lines', name: 'DLF (Base)', line: { dash: 'dash', color: 'gray', width: 1 }, showlegend: false, hoverinfo: 'none' },
                { x: slf_base, y: r_range, mode: 'lines', name: 'SLF (Base)', line: { dash: 'dash', color: 'gray', width: 1 }, showlegend: false, hoverinfo: 'none' },
                { x: dlf_new, y: r_range, mode: 'lines', name: 'DLF\' (Fiscal)', line: { color: 'red', width: 3 } },
                { x: slf_new, y: r_range, mode: 'lines', name: 'SLF\' (Monetary)', line: { color: 'blue', width: 3 } },
                { x: [q_new], y: [r_new], mode: 'markers', name: 'E1', marker: { size: 10, color: 'black', symbol: 'diamond' } },
                { x: [EQ_Q], y: [EQ_R], mode: 'markers', name: 'E0', marker: { size: 10, color: 'green', symbol: 'circle' }, showlegend: false },
            ];

            const mlfLayout = {
                title: 'Loanable Funds Market (MLF)',
                xaxis: { title: 'Quantity of Loanable Funds (QLF)', range: [50, 150] },
                yaxis: { title: 'Real Interest Rate (r)', range: [1, 9] },
                showlegend: true,
                legend: { x: 1.05, y: 0.9, xanchor: 'left' },
                annotations: [
                    { x: EQ_Q, y: EQ_R, text: 'E<sub>0</sub>', showarrow: true, arrowhead: 1, ax: -30, ay: -30 }, 
                    { x: q_new, y: r_new, text: 'E<sub>1</sub>', showarrow: true, arrowhead: 1, ax: 30, ay: -30 }
                ]
            };

            Plotly.newPlot('mlfGraph', traces, mlfLayout, { displayModeBar: false });
            return { r_new, fiscalShift };
        }

        // --- 2. Aggregate Supply-Aggregate Demand (AS-AD) Functions ---
        
        function getADCurve(pl, shift) {
            let rgdp = [];
            // AD Slope is defined by 1/SLOPE_D, but we use SLOPE_D for consistency in the equation structure
            for (let i = 0; i < pl.length; i++) {
                rgdp.push(EQ_RGDP + (EQ_PL - pl[i]) / SLOPE_D + shift);
            }
            return rgdp;
        }

        function getSRASCurve(pl) {
            let rgdp = [];
            for (let i = 0; i < pl.length; i++) {
                rgdp.push(EQ_RGDP + (pl[i] - EQ_PL) / SLOPE_S);
            }
            return rgdp;
        }

        function calculateASADEquilibrium(ad_shift) {
            // New PL is the intersection of SRAS and AD'
            // PL_new = EQ_PL + (SLOPE_S * SLOPE_D / (SLOPE_S + SLOPE_D)) * AD_shift
            const pl_new = EQ_PL + (SLOPE_S * SLOPE_D / (SLOPE_S + SLOPE_D)) * ad_shift;
            
            // New RGDP from the SRAS curve equation
            const rgdp_new = EQ_RGDP + (pl_new - EQ_PL) / SLOPE_S;

            return { pl_new, rgdp_new };
        }

        function createASADGraph(r_new, fiscalShift) {
            const pl_range = Array.from({ length: 41 }, (_, i) => 80 + i * 1); 

            // 1. Direct Effect: Fiscal Multiplier applies to the base shift.
            const direct_fiscal_effect = fiscalShift * FISCAL_MULTIPLIER;
            
            // 2. Crowding-Out/In Effect
            // r_change is POSITIVE if r_new rises (Crowding Out), NEGATIVE if r_new falls (Crowding In)
            const r_change = r_new - EQ_R; 
            
            // Crowding effect is always the opposite of the r_change on the AD curve (I & C fall if r rises)
            // (EQ_R - r_new) is a negative number when r_new > EQ_R (Crowding OUT), yielding a negative crowding effect
            const crowding_effect = (EQ_R - r_new) * AD_SENSITIVITY; 

            // Total AD Shift 
            const ad_shift = direct_fiscal_effect + crowding_effect;
            
            const { pl_new, rgdp_new } = calculateASADEquilibrium(ad_shift);

            const ad_base = getADCurve(pl_range, 0); 
            const sras = getSRASCurve(pl_range);
            const ad_new = getADCurve(pl_range, ad_shift);

            const traces = [
                { x: ad_base, y: pl_range, mode: 'lines', name: 'AD (Base)', line: { dash: 'dash', color: 'gray', width: 1 }, showlegend: false, hoverinfo: 'none' },
                { x: sras, y: pl_range, mode: 'lines', name: 'SRAS', line: { color: 'green', width: 3 } },
                { x: Array(pl_range.length).fill(MAX_RGDP), y: pl_range, mode: 'lines', name: 'LRAS', line: { dash: 'dot', color: 'purple' }, hoverinfo: 'none' },
                { x: ad_new, y: pl_range, mode: 'lines', name: 'AD\'', line: { color: 'red', width: 3 } },
                { x: [rgdp_new], y: [pl_new], mode: 'markers', name: 'E1', marker: { size: 10, color: 'black', symbol: 'diamond' } },
                { x: [EQ_RGDP], y: [EQ_PL], mode: 'markers', name: 'E0', marker: { size: 10, color: 'green', symbol: 'circle' }, showlegend: false },
            ];

            const asadLayout = {
                title: 'Aggregate Demand - Aggregate Supply (AS-AD)',
                xaxis: { title: 'Real GDP (rgdp)', range: [400, 600] },
                yaxis: { title: 'Price Level (PL)', range: [80, 120] },
                showlegend: true,
                legend: { x: 1.05, y: 0.9, xanchor: 'left' },
                annotations: [
                    { x: EQ_RGDP, y: EQ_PL, text: 'E<sub>0</sub>', showarrow: true, arrowhead: 1, ax: -30, ay: -30 },
                    { x: rgdp_new, y: pl_new, text: 'E<sub>1</sub>', showarrow: true, arrowhead: 1, ax: 30, ay: -30 }
                ]
            };

            Plotly.newPlot('asadGraph', traces, asadLayout, { displayModeBar: false });
            return { pl_new, rgdp_new, r_change };
        }

        // --- 3. Update Function (Called by Sliders) ---

        function updateGraphs() {
            const fiscalPolicyValue = parseFloat(document.getElementById('fiscalPolicy').value);
            const monetaryPolicyValue = parseFloat(document.getElementById('monetaryPolicy').value);

            document.getElementById('fiscalValue').textContent = fiscalPolicyValue;
            document.getElementById('monetaryValue').textContent = monetaryPolicyValue;

            // Step 1: Update MLF Graph and get the new Real Interest Rate (r')
            const mlf_results = createMLFGraph(fiscalPolicyValue, monetaryPolicyValue);
            
            // Step 2: Update the AS-AD Graph
            const asad_results = createASADGraph(mlf_results.r_new, fiscalPolicyValue);

            // Step 3: Update Output Panel
            document.getElementById('r_new_output').textContent = mlf_results.r_new.toFixed(2) + '%';
            document.getElementById('pl_new_output').textContent = asad_results.pl_new.toFixed(2);
            document.getElementById('rgdp_new_output').textContent = asad_results.rgdp_new.toFixed(2);

            let lras_impact_element = document.getElementById('lras_impact_output');
            lras_impact_element.classList.remove('lras-negative', 'lras-positive', 'lras-neutral');

            if (asad_results.r_change > 0.1) {
                lras_impact_element.textContent = `SLOWER (Crowding Out, r â†‘ by ${asad_results.r_change.toFixed(2)}%)`;
                lras_impact_element.classList.add('lras-negative');
            } else if (asad_results.r_change < -0.1) {
                lras_impact_element.textContent = `FASTER (Crowding In, r â†“ by ${Math.abs(asad_results.r_change).toFixed(2)}%)`;
                lras_impact_element.classList.add('lras-positive');
            } else {
                lras_impact_element.textContent = 'Neutral';
                lras_impact_element.classList.add('lras-neutral');
            }
        }
        
        // **STABLE INITIALIZATION**: Using window.onload for maximum compatibility
        window.onload = updateGraphs;
    </script>

</body>
</html>
